<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>WebAR: 3D –†–æ–±–æ—Ç –Ω–∞ –º–∞—Ä–∫–µ—Ä–µ</title>
    <link rel="stylesheet" href="css/style.css">
       
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ A-Frame –∏–∑ –Ω–∞–¥–µ–∂–Ω–æ–≥–æ CDN -->
    <script src="https://cdn.jsdelivr.net/gh/aframevr/aframe@v1.4.0/dist/aframe-master.min.js"></script>
    
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ AR.js –∏–∑ –Ω–∞–¥–µ–∂–Ω–æ–≥–æ CDN -->
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.0/aframe/build/aframe-ar.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aframe-extras@6.1.1/dist/aframe-extras.min.js"></script>
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞ -->
    <script src="js/app.js" defer></script>
    
<script>
    // iOS —Ñ–∏–∫—Å –¥–ª—è —Ä–∞–∑–¥–µ–ª–µ–Ω–Ω–æ–≥–æ —ç–∫—Ä–∞–Ω–∞
    if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
        console.log('üì± –ü—Ä–∏–º–µ–Ω—è–µ–º iOS —Ñ–∏–∫—Å—ã...');
        
        // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ A-Frame
        window.addEventListener('load', function() {
            setTimeout(function() {
                const scene = document.querySelector('a-scene');
                if (!scene) return;
                
                // 1. –£–±–∏—Ä–∞–µ–º —Ä–∞–∑–¥–µ–ª–µ–Ω–Ω—ã–π —ç–∫—Ä–∞–Ω
                scene.setAttribute('vr-mode-ui', 'enabled: false');
                
                // 2. –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–æ–ª–µ–µ —Å—Ç–∞–±–∏–ª—å–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
                scene.setAttribute('arjs', {
                    sourceType: 'webcam',
                    debugUIEnabled: false,
                    trackingMethod: 'best',
                    maxDetectionRate: 30, // –°–Ω–∏–∂–∞–µ–º –¥–ª—è iOS
                    canvasWidth: window.innerWidth,
                    canvasHeight: window.innerHeight
                });
                
                // 3. –ò—Å–ø—Ä–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –∫–∞–Ω–≤–∞—Å–∞
                const canvas = scene.querySelector('canvas');
                if (canvas) {
                    canvas.style.cssText = `
                        position: fixed !important;
                        top: 0 !important;
                        left: 0 !important;
                        width: 100vw !important;
                        height: 100vh !important;
                        display: block !important;
                        z-index: 1 !important;
                    `;
                }
                
                // 4. –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π resize
                if (scene.renderer) {
                    scene.renderer.setSize(window.innerWidth, window.innerHeight);
                }
                
                console.log('‚úÖ iOS —Ñ–∏–∫—Å—ã –ø—Ä–∏–º–µ–Ω–µ–Ω—ã');
                
            }, 1000); // –î–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ –∑–∞–≥—Ä—É–∑–∫—É
        });
    }
</script>

    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üöÄ</text></svg>">
    
    <!-- –°–∫—Ä–∏–ø—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ -->
    <script>
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫
        window.addEventListener('load', function() {
            console.log('–ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫...');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º Three.js
            if (typeof THREE === 'undefined') {
                console.error('Three.js –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
                document.getElementById('status-message').textContent = '–û—à–∏–±–∫–∞: Three.js –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω';
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º A-Frame
            if (typeof AFRAME === 'undefined') {
                console.error('A-Frame –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
                document.getElementById('status-message').textContent = '–û—à–∏–±–∫–∞: A-Frame –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω';
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º AR.js
            if (!AFRAME || !AFRAME.components['arjs']) {
                console.warn('AR.js –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω –ø–æ–ª–Ω–æ—Å—Ç—å—é, –Ω–æ –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å');
            }
        });
    </script>
</head>
<body>
    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è -->
    <div id="app">
        
        <!-- –ü–∞–Ω–µ–ª—å —Å—Ç–∞—Ç—É—Å–∞ -->
        <div id="status-panel" class="panel">
            <p id="status-message">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ AR...</p>
            <div id="permission-hint" class="hidden">
                <p>–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∏—Ç –¥–æ—Å—Ç—É–ø –∫ –≤–∞—à–µ–π –∫–∞–º–µ—Ä–µ. –ù–∞–∂–º–∏—Ç–µ "–†–∞–∑—Ä–µ—à–∏—Ç—å".</p>
                <button id="start-button">–ù–∞—á–∞—Ç—å AR-–æ–ø—ã—Ç</button>
            </div>
        </div>

        <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è AR-—Å—Ü–µ–Ω—ã -->
        <div id="ar-container" class="hidden">
            <!-- –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è —Å—Ü–µ–Ω–∞ A-Frame -->
            <a-scene 
                embedded 
                vr-mode-ui="enabled: false"
                renderer="antialias: true; alpha: true; precision: medium;"
                arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;"
                gesture-detector>
                
                <!-- –ú–∞—Ä–∫–µ—Ä (–ø–∞—Ç—Ç–µ—Ä–Ω) -->
                <a-marker 
                     id="main-marker"
    preset="hiro"
    type="pattern"
    emitevents="true"
    smooth="true"
    smoothCount="10"
    smoothTolerance="0.01">
                    
                    <!-- 3D –º–æ–¥–µ–ª—å -->
<a-entity 
    id="robot-model"
    gltf-model="url(assets/models/robot.glb)"
    position="0 0.5 0"
    scale="0.5 0.5 0.5"
    shadow="receive: false">
</a-entity>
                    
                </a-marker>
                
                <!-- –ö–∞–º–µ—Ä–∞ —Å—Ü–µ–Ω—ã -->
                <a-entity camera></a-entity>
                
            </a-scene>

            <!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–æ–¥–µ–ª—å—é -->
            <div id="controls-panel" class="panel hidden">
                <div class="controls-grid">
                    <button class="control-btn" data-action="rotate-left" title="–ü–æ–≤–µ—Ä–Ω—É—Ç—å –≤–ª–µ–≤–æ">
                        ‚Ü∂
                    </button>
                    <button class="control-btn" data-action="scale-up" title="–£–≤–µ–ª–∏—á–∏—Ç—å">
                        <span class="icon">+</span>
                    </button>
                    <button class="control-btn" data-action="scale-down" title="–£–º–µ–Ω—å—à–∏—Ç—å">
                        <span class="icon">‚àí</span>
                    </button>
                    <button class="control-btn" data-action="rotate-right" title="–ü–æ–≤–µ—Ä–Ω—É—Ç—å –≤–ø—Ä–∞–≤–æ">
                        ‚Ü∑
                    </button>
                    <button class="control-btn wide" data-action="reset" title="–°–±—Ä–æ—Å–∏—Ç—å">
                        –°–±—Ä–æ—Å
                    </button>
                </div>
            </div>

            <!-- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
            <div id="instruction" class="panel">
                <p>–ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ –º–∞—Ä–∫–µ—Ä</p>
                <div class="marker-preview">
                    <img src="assets/markers/hiro.png" alt="–ú–∞—Ä–∫–µ—Ä">
                </div>
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω –æ—à–∏–±–∫–∏ -->
        <div id="error-panel" class="panel hidden">
            <h3>‚ö†Ô∏è –û—à–∏–±–∫–∞</h3>
            <p id="error-message"></p>
            <button id="retry-button">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>
        </div>

    </div>

    <!-- –°–∫—Ä–∏–ø—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ -->
    <script>
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è iOS - —Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–µ–π—Å—Ç–≤–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∫–∞–º–µ—Ä—ã
        document.getElementById('start-button').addEventListener('click', function() {
            document.getElementById('permission-hint').classList.add('hidden');
            document.getElementById('status-message').textContent = "–ó–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã...";
            
            // –ò–º–∏—Ç–∏—Ä—É–µ–º –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É –¥–ª—è –ª—É—á—à–µ–≥–æ UX
            setTimeout(() => {
                document.getElementById('ar-container').classList.remove('hidden');
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è AR —Å—Ü–µ–Ω—ã –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
            }, 500);
        });
    </script>
</body>
</html>